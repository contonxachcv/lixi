<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L√¨ X√¨</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            color: #fff;
            overflow-x: hidden;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
        }

        #bg-video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -2;
        }

        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.35);
            z-index: -1;
        }

        .outer-container {
            position: relative;
            z-index: 1;
            width: 100%;
            max-width: 420px;
            padding: 10px 15px;
            opacity: 0;
            transform: scale(0.85);
            animation: frameAppear 1.2s ease-out forwards;
            animation-delay: 0.4s;
        }

        @keyframes frameAppear {
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .inner-container {
            background: rgba(255, 255, 255, 0.92);
            padding: 20px 25px;
            border-radius: 18px;
            box-shadow: 0 6px 25px rgba(0,0,0,0.4);
            backdrop-filter: blur(4px);
            min-height: 180px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        h1 {
            color: #c62828;
            margin: 0 0 8px;
            font-size: 1.8rem;
            opacity: 0;
            animation: titleAppear 1s ease-out forwards;
            animation-delay: 0.8s;
        }

        .subtitle {
            color: #b71c1c;
            font-size: 1.1rem;
            margin: 0 0 20px;
            font-weight: 500;
            opacity: 0;
            animation: titleAppear 1.2s ease-out forwards;
            animation-delay: 1.1s;
        }

        @keyframes titleAppear {
            to { opacity: 1; transform: translateY(0); }
        }

        .envelope-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px 18px;
            width: 100%;
            max-width: 320px;
            margin: 0 auto;
        }

        .envelope {
            width: 70px;
            height: 95px;
            background-size: cover;
            background-position: center;
            border: 2px solid #ffd700;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.25);
            opacity: 0.95;
        }

        .envelope:hover {
            transform: scale(1.1) rotate(2deg);
            box-shadow: 0 6px 15px rgba(255, 215, 0, 0.5);
            opacity: 1;
        }

        .envelope.opened {
            background: #e0e0e0 !important;
            border-color: #aaa;
            cursor: default;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.6);
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 25px;
            max-width: 90%;
            width: 600px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: row;
            gap: 25px;
            position: relative;
            animation: modalPop 0.5s ease-out;
        }

        @keyframes modalPop {
            from { transform: scale(0.7); opacity: 0; }
            to   { transform: scale(1); opacity: 1; }
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            color: #c62828;
            cursor: pointer;
            font-weight: bold;
        }

        .message-area, .scratch-area {
            flex: 1;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .message-area {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            padding: 25px 20px;
            color: #c62828;
            min-height: 280px;
            text-align: center;
        }

        .message-area h2 {
            margin: 0 0 15px;
            font-size: 1.8rem;
        }

        .message-area p {
            margin: 0 0 20px;
            font-size: 1.15rem;
            line-height: 1.6;
        }

        .meme-image {
            max-width: 100%;
            max-height: 180px;
            object-fit: contain;
            border-radius: 12px;
            margin-top: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .scratch-area {
            background: #111;
            position: relative;
            aspect-ratio: 4 / 5;
            width: 100%;
            max-width: 280px;
            min-height: 320px;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 6px 20px rgba(0,0,0,0.35);
        }

        #scratchCanvas {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
        }

        .cover-layer {
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, #757575, #424242);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ffeb3b;
            font-size: 1.25rem;
            font-weight: bold;
            text-shadow: 1px 1px 5px #000;
            pointer-events: none;
            padding: 20px;
            z-index: 2;
        }

        .money-image {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            display: none;
            z-index: 1;
        }

        .music-control {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 100;
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.4);
        }

        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-2px, -3px) rotate(-2deg); }
            20% { transform: translate(-4px, 0px) rotate(2deg); }
            30% { transform: translate(4px, 3px) rotate(0deg); }
            40% { transform: translate(2px, -2px) rotate(2deg); }
            50% { transform: translate(-2px, 3px) rotate(-2deg); }
            60% { transform: translate(-4px, 2px) rotate(0deg); }
            70% { transform: translate(4px, 2px) rotate(-2deg); }
            80% { transform: translate(-2px, -2px) rotate(2deg); }
            90% { transform: translate(2px, 3px) rotate(0deg); }
            100% { transform: translate(1px, -3px) rotate(-2deg); }
        }

        .shake-super {
            animation: shake 1.4s cubic-bezier(0.36, 0.07, 0.19, 0.97) both;
        }

        .shake-normal {
            animation: shake 0.8s cubic-bezier(0.36, 0.07, 0.19, 0.97) both;
        }

        @media (max-width: 650px) {
            .modal-content {
                flex-direction: column;
                width: 94%;
                padding: 20px;
            }
            .scratch-area {
                max-width: 320px;
                min-height: 380px;
            }
            .message-area {
                min-height: 300px;
            }
            .meme-image {
                max-height: 160px;
            }
        }
    </style>
</head>
<body>

    <video autoplay muted loop playsinline id="bg-video">
        <source src="anh/back.mp4" type="video/mp4">
        Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ video.
    </video>

    <div class="overlay"></div>

    <button class="music-control" id="musicToggle">üîä</button>

    <audio id="bgMusic" loop>
        <source src="anh/nhac.mp3" type="audio/mpeg">
    </audio>

    <!-- Nh·∫°c cho 100k & 200k -->
    <audio id="winMusic">
        <source src="anh/nhacme1.mp3" type="audio/mpeg">
    </audio>

    <!-- Nh·∫°c RI√äNG cho t·ªù 500k meme (amount = 500) -->
    <audio id="superWinMusic">
        <source src="anh/nhacme3.mp3" type="audio/mpeg">
    </audio>

    <!-- Nh·∫°c cho 10k, 20k, 50k -->
    <audio id="mediumMusic">
        <source src="anh/nhacme2.mp3" type="audio/mpeg">
    </audio>

    <div class="outer-container">
        <div class="inner-container">
            <h1>Ch√∫c M·ª´ng NƒÉm M·ªõi!</h1>
            <div class="subtitle">Nh·∫•n v√†o l√¨ x√¨ ƒë·ªÉ nh·∫≠n may m·∫Øn</div>
            <div class="envelope-grid" id="envelopeGrid"></div>
        </div>
    </div>

    <div class="modal" id="resultModal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">√ó</span>

            <div class="message-area" id="messageArea">
                <div>
                    <h2>Ch√∫c m·ª´ng!</h2>
                    <p id="luckyMessage"></p>
                </div>
                <img id="memeImage" class="meme-image" alt="Meme vui" src="">
            </div>

            <div class="scratch-area">
                <canvas id="scratchCanvas"></canvas>
                <img id="moneyImage" class="money-image" alt="T·ªù ti·ªÅn may m·∫Øn">
                <div class="cover-layer" id="coverLayer">C√†o ƒë·ªÉ xem s·ªë ti·ªÅn!</div>
            </div>
        </div>
    </div>

    <script>
        // D·ªØ li·ªáu
        const luckyMessages = [
            "L√¨ x√¨ v·∫≠y th√¥i, ƒë·ª´ng nh√¨n s·ªë ti·ªÅn m√† bu·ªìn.",
            "C·∫ßm l·∫•y m√† ƒÉn T·∫øt, nh·ªõ ƒë·ª´ng ƒë√≤i th√™m.",
            "anh/ch·ªã l√¨ x√¨ b·∫±ng c·∫£ t·∫•m l√≤ng‚Ä¶ ch·ª© kh√¥ng ph·∫£i c·∫£ v√≠ ti·ªÅn.",
            "NƒÉm nay ph√°t √≠t, nƒÉm sau ph√°t nhi·ªÅu‚Ä¶ n·∫øu tr√∫ng s·ªë.",
            "S·ªë ti·ªÅn kh√¥ng quan tr·ªçng, quan tr·ªçng l√†‚Ä¶ c√≥ ti·ªÅn.",
            "L√¨ x√¨ √≠t nh∆∞ng t√¨nh c·∫£m nhi·ªÅu (nhi·ªÅu thi·ªát).",
            "Ch√∫c nƒÉm m·ªõi gi√†u sang, c√≤n hi·ªán t·∫°i th√¨‚Ä¶ r√°ng ch·ªãu.",
            "Ch√∫c h·ªçc gi·ªèi h∆°n nƒÉm ngo√°i, ƒë·ª´ng gi·ªèi h∆°n anh/ch·ªã l√† ƒë∆∞·ª£c."
        ];

        const memeImages = [
            "anh/meme1.jpg",
            "anh/meme2.jpg",
            "anh/meme3.png",
            "anh/meme4.jpg",
            "anh/meme5.jpg",
            "anh/meme6.png"
        ];

        const moneyImages = {
            500:     "anh/500kmeme.jpg",     // t·ªù 500k meme
            10000:   "anh/10k.jpg",
            20000:   "anh/20k.jpg",
            50000:   "anh/50k.jpg",
            100000:  "anh/100k.jpg",
            200000:  "anh/200k.jpg",
            500000:  "anh/500k.jpg"          // t·ªù 500k th∆∞·ªùng (n·∫øu c√≥)
        };

        const liXiImages = ["anh/lixi1.png", "anh/lixi2.png", "anh/lixi3.png"];

        const moneyWeights = [
            { amount: 500,    weight: 23.5 },
            { amount: 10000,  weight: 18   },
            { amount: 20000,  weight: 20   },
            { amount: 50000,  weight: 14.9 },
            { amount: 100000, weight: 12   },
            { amount: 200000, weight: 8    },
            { amount: 500000, weight: 3.6  }
        ];

        // Ph√¢n lo·∫°i m·ª©c th∆∞·ªüng
        const superWinAmounts   = [500];                    // t·ªù 500k meme
        const normalWinAmounts  = [100000, 200000];         // 100k & 200k
        const mediumWinAmounts  = [10000, 20000, 50000];    // ch·ªâ nh·∫°c

        // H√†m h·ªó tr·ª£
        function getMoneyImageUrl(amount) {
            return moneyImages[amount] || moneyImages[500];
        }

        function getRandomItem(arr) {
            return arr[Math.floor(Math.random() * arr.length)];
        }

        const weightedAmounts = [];
        moneyWeights.forEach(item => {
            for (let i = 0; i < item.weight * 10; i++) {
                weightedAmounts.push(item.amount);
            }
        });

        // DOM & Audio
        const modal = document.getElementById('resultModal');
        const messageEl = document.getElementById('luckyMessage');
        const coverLayer = document.getElementById('coverLayer');
        const moneyImage = document.getElementById('moneyImage');
        const memeImage = document.getElementById('memeImage');
        const grid = document.getElementById('envelopeGrid');

        const winMusic       = document.getElementById('winMusic');
        const superWinMusic  = document.getElementById('superWinMusic');
        const mediumMusic    = document.getElementById('mediumMusic');

        winMusic.volume      = 0.6;
        superWinMusic.volume = 0.7;
        mediumMusic.volume   = 0.6;

        // Reset t·∫•t c·∫£ hi·ªáu ·ª©ng & nh·∫°c
        function resetEffects() {
            const modalContent = document.querySelector('.modal-content');
            const messageArea = document.getElementById('messageArea');

            modalContent.classList.remove('shake-super', 'shake-normal');
            messageArea.style.background = 'linear-gradient(135deg, #fff3e0, #ffe0b2)';

            [winMusic, superWinMusic, mediumMusic].forEach(m => {
                m.pause();
                m.currentTime = 0;
            });
        }

        // ƒê√≥ng modal
        function closeModal() {
            modal.style.display = 'none';
            coverLayer.style.display = 'flex';
            moneyImage.style.display = 'none';
            resetEffects();

            if (canvas) {
                ctx.globalCompositeOperation = 'source-over';
                ctx.fillStyle = '#616161';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
        }

        modal.onclick = (e) => {
            if (e.target === modal) closeModal();
        };

        // Scratch logic
        let canvas, ctx;

        function initScratch(amount) {
            canvas = document.getElementById('scratchCanvas');
            ctx = canvas.getContext('2d');

            const rect = canvas.parentElement.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;

            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            canvas.style.width = `${rect.width}px`;
            canvas.style.height = `${rect.height}px`;

            ctx.scale(dpr, dpr);
            ctx.fillStyle = '#616161';
            ctx.fillRect(0, 0, rect.width, rect.height);
            ctx.globalCompositeOperation = 'destination-out';

            let isDrawing = false;

            function startScratch(e) { 
                isDrawing = true; 
                scratch(e); 
            }
            function endScratch() { isDrawing = false; }

            function scratch(e) {
                if (!isDrawing) return;

                const rect = canvas.getBoundingClientRect();
                const x = ((e.clientX || (e.touches && e.touches[0].clientX)) - rect.left) * dpr;
                const y = ((e.clientY || (e.touches && e.touches[0].clientY)) - rect.top) * dpr;

                ctx.beginPath();
                ctx.arc(x, y, 42, 0, Math.PI * 2);
                ctx.fill();

                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const transparentPixels = imageData.data.filter((v, i) => i % 4 === 3 && v < 10).length;
                const totalPixels = canvas.width * canvas.height;

                if (transparentPixels / totalPixels > 0.75) {
                    coverLayer.style.display = 'none';
                    moneyImage.src = getMoneyImageUrl(amount);
                    moneyImage.style.display = 'flex';

                    // Reset tr∆∞·ªõc khi √°p d·ª•ng hi·ªáu ·ª©ng m·ªõi
                    resetEffects();

                    const modalContent = document.querySelector('.modal-content');
                    const messageArea = document.getElementById('messageArea');
                    const originalBg = 'linear-gradient(135deg, #fff3e0, #ffe0b2)';

                    if (superWinAmounts.includes(amount)) {
                        // 500k meme - si√™u ƒë·∫∑c bi·ªát
                        superWinMusic.play().catch(e => console.log("Super win music error:", e));
                        modalContent.classList.add('shake-super');
                        setTimeout(() => modalContent.classList.remove('shake-super'), 1800);
                        launchSuperConfetti();
                        messageArea.style.background = 'linear-gradient(135deg, #ffeb3b, #ff9800, #f44336, #ffd700)';
                        setTimeout(() => { messageArea.style.background = originalBg; }, 10000);
                    } 
                    else if (normalWinAmounts.includes(amount)) {
                        // 100k, 200k
                        winMusic.play().catch(e => console.log("Win music error:", e));
                        modalContent.classList.add('shake-normal');
                        setTimeout(() => modalContent.classList.remove('shake-normal'), 1200);
                        launchConfetti();
                        messageArea.style.background = 'linear-gradient(135deg, #ffd700, #ff6f00)';
                        setTimeout(() => { messageArea.style.background = originalBg; }, 6000);
                    } 
                    else if (mediumWinAmounts.includes(amount)) {
                        // 10k, 20k, 50k - ch·ªâ nh·∫°c, kh√¥ng hi·ªáu ·ª©ng
                        mediumMusic.play().catch(e => console.log("Medium music error:", e));
                    } 
                    else {
                        console.warn("Amount kh√¥ng thu·ªôc nh√≥m n√†o:", amount);
                    }
                }
            }

            canvas.addEventListener('mousedown', startScratch);
            canvas.addEventListener('touchstart', startScratch, { passive: false });
            canvas.addEventListener('mousemove', scratch);
            canvas.addEventListener('touchmove', scratch, { passive: false });
            canvas.addEventListener('mouseup', endScratch);
            canvas.addEventListener('touchend', endScratch);
            canvas.addEventListener('mouseleave', endScratch);
        }

        function launchConfetti() {
            const duration = 5000;
            const end = Date.now() + duration;
            (function frame() {
                confetti({ particleCount: 7, angle: 60, spread: 55, origin: { x: 0 } });
                confetti({ particleCount: 7, angle: 120, spread: 55, origin: { x: 1 } });
                if (Date.now() < end) requestAnimationFrame(frame);
            }());
        }

        function launchSuperConfetti() {
            const duration = 8000;
            const end = Date.now() + duration;
            (function frame() {
                confetti({
                    particleCount: 12,
                    angle: 60,
                    spread: 70,
                    origin: { x: 0 },
                    colors: ['#ffeb3b', '#ffd700', '#ffffff', '#ff9800']
                });
                confetti({
                    particleCount: 12,
                    angle: 120,
                    spread: 70,
                    origin: { x: 1 },
                    colors: ['#ffeb3b', '#ffd700', '#ffffff', '#ff9800']
                });
                if (Date.now() < end) requestAnimationFrame(frame);
            }());
        }

        // T·∫°o 9 phong b√¨
        const numEnvelopes = 9;

        for (let i = 0; i < numEnvelopes; i++) {
            const amount = getRandomItem(weightedAmounts);
            const liXiImg = getRandomItem(liXiImages);

            const envelopeDiv = document.createElement('div');
            envelopeDiv.className = 'envelope';
            envelopeDiv.style.backgroundImage = `url('${liXiImg}')`;

            envelopeDiv.onclick = () => {
                if (envelopeDiv.classList.contains('opened')) return;
                envelopeDiv.classList.add('opened');

                messageEl.textContent = getRandomItem(luckyMessages);
                memeImage.src = getRandomItem(memeImages);
                memeImage.style.display = 'block';

                modal.style.display = 'flex';

                setTimeout(() => initScratch(amount), 300);
            };

            grid.appendChild(envelopeDiv);
        }

        // Nh·∫°c n·ªÅn
        const music = document.getElementById('bgMusic');
        const toggleBtn = document.getElementById('musicToggle');

        music.volume = 0.4;
        music.play().catch(() => console.log("Autoplay b·ªã ch·∫∑n"));

        toggleBtn.onclick = () => {
            if (music.paused) {
                music.play();
                toggleBtn.textContent = 'üîä';
            } else {
                music.pause();
                toggleBtn.textContent = 'üîá';
            }
        };
    </script>
</body>
</html>